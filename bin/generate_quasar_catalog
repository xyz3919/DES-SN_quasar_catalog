#!/usr/bin/env python
#
import numpy as np
from quasar_catalog import main
from quasar_catalog import plot
from quasar_catalog import query
import sys

if __name__ == '__main__':

    catalog = main.catalog()

    # select million quasar in SN fields
    milliqua_data = catalog.load_million_catalog()
    milliqua_in_SN = catalog.select_quasars_in_regions(milliqua_data,\
                     catalog.DES_SN_ra_dec.keys())

    catalog.print_and_write(catalog.file_record,"million quasars in SN:"+\
                         str(len(milliqua_in_SN)))

    np.savetxt(catalog.temp_catalog_dir+"milliqua_DES-SN.txt",\
               milliqua_in_SN,fmt="%f,%f,%s,%f,%s",\
               header="ra,dec,spec_flag,z,where")

    # adding OzDES catalog
    ozdes_data = catalog.load_OzDES_catalog()

    catalog.print_and_write(catalog.file_record,"OzDES quasars:"+\
                         str(len(ozdes_data)))

    combined = catalog.adding_second_catalog(milliqua_in_SN,ozdes_data,\
                                          "OzDES","Q","OzDESa")


    # cross-match with DES Y3A1 coadd catalog
    q = query.query()
    N = 1
    for row in combined:
        DES_coadd_object = q.get_coadd_object_spread_model(row['ra'],\
                           row['dec'])
        if DES_coadd_object is not None:
            new_row = np.array([(DES_coadd_object["ra"],\
                      DES_coadd_object["dec"],row["flag"],row["z"],\
                      row["where"],DES_coadd_object["flux_psf_r"],\
                      DES_coadd_object["spread_model_r"])],\
                      dtype=catalog.dtype+[("flux_psf_r",float),\
                      ("spread_model_r",float)])
            if N == 1: combined_in_DES = new_row
            else:
                combined_in_DES = np.concatenate((combined_in_DES,\
                                  new_row),axis=0)
            N = N+1
    catalog.print_and_write(catalog.file_record,"combined x DES Y3A1coadd:"+\
                         str(len(combined_in_DES)))

    np.savetxt(catalog.catalog_dir+"milliqua+OzDES_SN.txt",\
               combined_in_DES,fmt="%f,%f,%s,%f,%s,%f,%f",\
               header="ra,dec,spec_flag,z,where,flux_psf_r,spread_model_r")

    # extract spectroscapically confirmed quasars in S1 and S2

    combined_in_DES = np.genfromtxt(catalog.catalog_dir+\
                      "milliqua+OzDES_SN.txt",delimiter=",",\
                      dtype=catalog.dtype+[("flux_psf_r",float),\
                      ("spread_model_r",float)])
    quasars_S1S2 = catalog.select_quasars_in_regions(combined_in_DES,\
                  ["S1","S2"])
    catalog.print_and_write(catalog.file_record,"quasars in S1,S2:"+\
                         str(len(quasars_S1S2)))

    spec_quasars_S1S2 = catalog.select_spec_confirmed(quasars_S1S2)
    catalog.print_and_write(catalog.file_record,"spec quasars in S1,S2:"+\
                         str(len(spec_quasars_S1S2)))
    np.savetxt(catalog.catalog_dir+"spec_quasars_S1S2.txt",\
               spec_quasars_S1S2,fmt="%f,%f,%s,%f,%s,%f,%f",\
               header="ra,dec,spec_flag,z,where,flux_psf_r,spread_model_r")

    f1 = plot.plot()
    f1.plot_ra_dec(spec_quasars_S1S2["ra"],spec_quasars_S1S2["dec"],\
                     "spec_S1S2")

