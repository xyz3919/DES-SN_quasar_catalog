#!/usr/bin/env python
# 
import timeit
from lightcurve import main
import os
from lightcurve import query
import useful_funcs
import sys
import multiprocessing as mp


def func(quasar):

    lc = main.lc()
    save_line = ""
    name = useful_funcs.degtohexname(quasar["ra"],quasar["dec"])
    save_line = save_line+name
    useful_funcs.print_and_write(lc.log,"- "+name+"\n")

    #####################
    #  DES light curves #
    #####################

    lc.set_output_dir(lc.lc_dir+"DES/"+name)

    # query the data from DES database
    SV_Y5_quasars = lc.generate_finalcut_lightcurve(quasar)

    total_quasars = lc.convert_flux_to_mag(SV_Y5_quasars)
    total_quasars.sort(order="mjd_obs")

    # get median magnitude for the quasars without coadd mag
    quasar = lc.fill_coadd_mag_with_median_mag(quasar,total_quasars)

    # record the info for the quasar
    save_line = save_line+","+",".join(map(str,quasar))

    # save DES data
    save_line = lc.save_DES_lightcurves(total_quasars,save_line)

    #####################
    # SDSS light curves #
    #####################

    lc.set_output_dir(lc.lc_dir+"SDSS/"+name)

    # query the data from SDSS database
    SDSS_quasars = lc.generate_SDSS_lightcurves(quasar)

    # adjust to DES system
    spec = main.spectra()
    spec.get_SDSS_spectrum(quasar["ra"],quasar["dec"])
    mag_diff = spec.mag_SDSS_to_DES(name)

    save_line = lc.save_SDSS_lightcurves(SDSS_quasars,save_line,mag_diff)

    #################
    # PanSTARRs DR2 #
    #################

    lc.set_output_dir(lc.lc_dir+"PS/"+name)
    save_line = lc.generate_and_save_PS_lightcurves(quasar,save_line)

    '''
    # save combined lightcurves

    
    band_list = ["g","r","i","z"]
    output_dir = lc.lc_dir+"combined/"
    useful_funcs.create_dir(output_dir)
    useful_funcs.create_dir(output_dir+name)

    for band in band_list:
        filenames = [lc_SDSS.save_dir+name+"/"+band+".csv",\
                     lc.save_dir+name+"/"+band+".csv"]
        with open(output_dir+name+"/"+band+".csv", 'w') as outfile:
            for fname in filenames:
                if os.path.isfile(fname):
                    with open(fname) as infile:
                        for line in infile.readlines()[1:]:
                            newline = line.replace(","," ")
                            outfile.write(newline)
    ''' 

    return save_line

if __name__ == '__main__':

    start = timeit.default_timer()
    lc = main.lc()
    
    quasar_catalog = lc.load_quasar_catalog()
    pool = mp.Pool(mp.cpu_count()*3/4)
    save_lines = pool.map(func,quasar_catalog[0:30])
    #save_lines = func(quasar_catalog[1061])

    lc.write_header(quasar_catalog)
    f = open(lc.lc_dir+lc.lc_info_file,"a")
    f.write("\n".join(save_lines))
    f.close()

    stop = timeit.default_timer()
    useful_funcs.print_and_write(lc.log,"Execution Time:"+\
                                 str((stop-start)/60.)+" mins")
    

