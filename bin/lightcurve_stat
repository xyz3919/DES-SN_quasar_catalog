#!/usr/bin/env python
# 
import numpy as np
from lightcurve import main
from lightcurve import plot
import useful_funcs


if __name__ == '__main__':


    lc = main.lc("DES/")
    lc_info = np.genfromtxt(lc.lc_dir+lc.lc_info_file,delimiter=",",\
              skip_header=1,\
              dtype = [("name","|S20"),("ra",float),("dec",float),\
                       ("z",float),("flag_0","|S6"),("flag_1","|S6"),\
                       ("flag_2","|S6"),("flag_3","|S15"),\
                       ("mag_i",float),("spread_model_i",float),\
                       ("spread_model_err_i",float),\
                       ("N_DES_g",int),("N_DES_r",int),("N_DES_i",int),\
                       ("N_DES_z",int),("N_SDSS_g",int),("N_SDSS_r",int),\
                       ("N_SDSS_i",int),("N_SDSS_z",int)])
    print ("Parent_sample: "+str(len(lc_info)))
    N = 0
    clean_sample = np.array([],dtype=lc_info.dtype)
    for row in lc_info:
        N_pass = 0
        for band in lc.band_list:
            if( row["N_DES_"+band] > 50) and (row["N_SDSS_"+band] > 30) \
                and (row["spread_model_i"] < 0.005):
                N_pass = N_pass +1
        if N_pass > 1:
            clean_sample = np.append(clean_sample,row)
    print ("Number of Quasar with Enough epochs: "+str(len(clean_sample)))
    print ("z:"+str(np.median(clean_sample["z"])))
    print ("mag_i:"+str(np.median(clean_sample["mag_i"])))
    print ("N_DES_i:"+str(np.median(clean_sample["N_DES_i"])))
    print ("N_SDSS_i:"+str(np.median(clean_sample["N_SDSS_i"])))

    number_epochs_DES = plot.plot(2,2,figsize=(10,8))
    number_epochs_SDSS = plot.plot(2,2,figsize=(10,8))
    for band in lc.band_list:
        number_epochs_DES.plot_histogram(lc_info["N_DES_"+band],band)
        number_epochs_SDSS.plot_histogram(lc_info["N_SDSS_"+band],band)

    print ("Saving the DES number of epochs plot at 'plot/DES_epochs.png'")
    print ("Saving the SDSS number of epochs plot at 'plot/SDSS_epochs.png'")
    number_epochs_DES.savefig("plot/","DES_epochs.png",\
                              "Number of epochs in DES")
    number_epochs_SDSS.savefig("plot/","SDSS_epochs.png",\
                               "Number of epochs in SDSS")

    np.savetxt(lc.lc_dir+"lc_clean.csv",clean_sample,fmt="%s,"*18+"%s",\
               header=",".join(clean_sample.dtype.names),comments="")

    # cheack where the quasar from
    in_DR7_DR14 = np.any([clean_sample["flag_0"]==" DR14Q",\
                          clean_sample["flag_1"]=="  DR7Q"],axis=0)
    number_DR7_DR14 = len(clean_sample[in_DR7_DR14])

    print ("Number in SDSS DR7/14:"+str( number_DR7_DR14))
    print clean_sample[np.invert(in_DR7_DR14)]
            


